<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WAV Receiver Demo (Right)</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 24px;
        background: #f0f7ff;
      }
      h1 {
        margin-top: 0;
      }
      .status {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 6px;
        background: #fff3cd;
        color: #8a6d3b;
        border: 1px solid #ffeeba;
      }
      .panel {
        background: #fff;
        border: 1px solid #d9e2ff;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
      }
      #entries .entry {
        border-bottom: 1px solid #e5e7eb;
        padding: 8px 0;
      }
      #entries .meta {
        font-size: 12px;
        color: #4b5563;
      }
      #log .entry {
        margin: 4px 0;
      }
    </style>
  </head>
  <body>
    <h1>WAV Receiver Demo (Right)</h1>
    <div class="panel">
      <div class="status" id="status">接続中...</div>
      <div id="last-received"></div>
    </div>

    <div class="panel">
      <h2>受信したWAV</h2>
      <div id="entries"></div>
    </div>

    <div class="panel">
      <h2>ログ</h2>
      <div id="log"></div>
    </div>

    <section aria-label="setup">
      <h2>利用手順</h2>
      <ol>
        <li><code>npm run start</code> でローカルHubを起動</li>
        <li><code>npm run demo</code> でデモ用サーバーを起動（このページは <code>http://127.0.0.1:4100</code>）</li>
        <li>別ブラウザで <code>http://127.0.0.1:3100</code> のWAV Leftデモを開き、send to hub をONにして生成</li>
      </ol>
    </section>

    <script type="module">
      import CrossOriginHub from '../cross-origin-hub.js';

      const statusEl = document.getElementById('status');
      const entriesEl = document.getElementById('entries');
      const logEl = document.getElementById('log');
      const lastReceivedEl = document.getElementById('last-received');
      const hub = new CrossOriginHub();
      const urls = [];
      const MAX_ENTRIES = 10;

      function setStatus(text, color) {
        statusEl.textContent = text;
        if (color) {
          statusEl.style.background = color;
        } else {
          statusEl.style.background = '#fff3cd';
        }
      }

      function addLog(text) {
        const entry = document.createElement('div');
        entry.className = 'entry';
        entry.textContent = text;
        logEl.appendChild(entry);
      }

      hub.on('_connected', () => setStatus('接続済み', '#e0ffe5'));
      hub.on('_disconnected', () => setStatus('切断されました', '#ffeaea'));
      hub.on('_error', (err) => {
        setStatus('エラー', '#ffeaea');
        addLog(`error: ${err?.message || err}`);
      });

      function base64ToBlob(base64, mime) {
        const binary = atob(base64);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i += 1) {
          bytes[i] = binary.charCodeAt(i);
        }
        return new Blob([bytes], { type: mime });
      }

      function addEntry({ id, name, mime, from, timestamp, url, durationMs }) {
        const wrapper = document.createElement('div');
        wrapper.className = 'entry';
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = url;
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = `${name || id || 'wav'} • ${mime} • from ${from || 'unknown'} • ${new Date(
          timestamp || Date.now()
        ).toLocaleTimeString()}${durationMs ? ` • ${durationMs}ms` : ''}`;
        wrapper.appendChild(audio);
        wrapper.appendChild(meta);
        entriesEl.prepend(wrapper);
        while (entriesEl.children.length > MAX_ENTRIES) {
          const removed = entriesEl.lastChild;
          const removedAudio = removed.querySelector('audio');
          if (removedAudio) {
            URL.revokeObjectURL(removedAudio.src);
          }
          removed.remove();
        }
      }

      hub.on('wav:generated', (data, meta) => {
        if (!data || typeof data.bytes !== 'string' || data.bytes.length === 0) {
          addLog('受信データが不正');
          return;
        }
        const mime = typeof data.mime === 'string' && data.mime ? data.mime : 'audio/wav';
        try {
          const blob = base64ToBlob(data.bytes, mime);
          const url = URL.createObjectURL(blob);
          urls.push(url);
          if (urls.length > MAX_ENTRIES) {
            const old = urls.shift();
            URL.revokeObjectURL(old);
          }

          const entry = {
            id: data.id,
            name: data.name,
            mime,
            from: meta?.from,
            timestamp: meta?.timestamp,
            url,
            durationMs: data.durationMs,
          };
          addEntry(entry);
          lastReceivedEl.textContent = `${entry.name || entry.id || 'wav'} を受信`;
          addLog(`received ${entry.name || entry.id || 'wav'}`);
        } catch (error) {
          addLog(`decode error: ${error.message || error}`);
        }
      });
    </script>
  </body>
</html>
