# Plan: send generated WAV to the hub and play it from tonejs-json-sequencer

## Goals
- Allow WAV generated by Tone.js / web-ym2151 / wavlpf to be pushed to Cross-Origin Hub with a single “send to hub” toggle.
- Let a tonejs-json-sequencer instance connected to the hub auto-load received WAVs into its sampler via a “wav from hub” toggle.
- Keep both toggles sticky (on stays on) so new renders travel automatically while the toggle is enabled.

## Shared message shape (hub payload)
- `eventType`: `wav:generated`
- `data` object:
  - `id`: string (stable identifier for deduping/reload)
  - `name`: string (display label / filename hint)
  - `mime`: string (e.g. `audio/wav`)
  - `bytes`: base64 string of the WAV file (JSON-safe for the current JSON-only hubs)
  - `durationMs`, `sampleRate`, `channels`: optional metadata
  - `source`: enum-like string (`tonejs`, `web-ym2151`, `wavlpf`, etc.)
- Hub already appends `from` and `timestamp`; receivers should trust `data` for audio and use `from` only as origin info.
- Future extension: once hubs and clients support binary WebSocket frames end-to-end, replace base64 `bytes` with a JSON envelope plus a separate binary frame/chunk protocol.

## JS npm helper for “send to hub” (tone.js / web-ym2151 / wavlpf producers)
- Package a thin helper around `cross-origin-hub`:
  - `createWavHubSender({ serverUrl, WebSocket })` returns `{ toggleSend(on), sendWav(wavBlob | ArrayBuffer, metadata) }`.
  - Internally holds `CrossOriginHub` instance, reuses connection, and publishes `wav:generated` with the shared shape.
- UI wiring:
  - “send to hub” button toggles a boolean; while on, any newly rendered WAV is fed to `sendWav`.
  - Keep the toggle state in memory (optionally localStorage later) and show a small status indicator wired to `_connected`, `_disconnected`, and `_error` hub events.
- Payload handling:
  - Convert Blob/ArrayBuffer to base64 before sending to stay compatible with current JSON-only hub.
  - Cap payload size (e.g. warn if > a few MB) and avoid chunking for the MVP; revisit chunking/URLs if size becomes an issue.

## Rust cargo (local hub) expectations
- cross-origin-hub-rs should mirror the Node hub behavior:
  - Accept JSON text messages with `eventType`/`data`, broadcast to other clients, and add `from` + `timestamp`.
  - For now, only accept JSON text frames; support for binary WebSocket frames is a future extension that will require coordinated changes to the Node hub and JS clients before being enabled.
  - Provide a `--max-payload` guard to avoid accidental huge audio posts.
- Optional convenience CLI flag for this use case:
  - `--watch-wav <dir>`: watch a folder where wavlpf outputs WAVs, base64 them, and emit `wav:generated` with `source=wavlpf`. This keeps the “send to hub” experience possible even for non-browser generators.

## tonejs-json-sequencer: “wav from hub” receiver
- Add a toggle button that, when on, connects (or reuses) a `CrossOriginHub` client and subscribes to `wav:generated`.
- On message:
  1) Validate payload before using it: ensure `data` exists, `typeof data.bytes === 'string'`, `data.bytes.length > 0`, and `data.mime === 'audio/wav'` (or another explicitly allowed audio MIME). Estimate decoded size and skip with a warning if above the allowed limit.
  2) Decode base64 to Blob inside try/catch; if decode fails, surface an error and abort without creating an Object URL or touching the sampler.
  3) If valid, turn the Blob into Object URL and register it into the sampler under `data.name` (or `id`) as a new slot, replacing duplicates keyed by `id`.
  4) Provide minimal UI feedback (loaded name, duration, source) and whether the payload was accepted or rejected by the guards.
- Handle duplicates by keying on `data.id`: replace existing sample if the same id reappears.
- Keep toggle sticky (stays on until manually turned off). If connection drops, retry via hub auto-reconnect and re-subscribe.

## Interaction model for the two toggles
- “Send to hub”: off by default; once turned on, every new WAV render auto-publishes.
- “wav from hub”: off by default; once on, all future hub-delivered WAVs auto-register.
- Start simple: no per-file prompts, no queue UI; just automatic transfer while toggled on. Add confirmations/filters only after the basic flow works.
